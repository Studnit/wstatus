<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aurus Certification Tracker Pro</title>

<style>
:root {
  --excel-green: #217346;
  --bg-color: #f4f7f6;
  --text-dark: #2c3e50;
  --border-color: #bdc3c7;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-color); margin: 0; padding: 20px 20px 40px 40px;
}

h1 { margin: 0; color: var(--text-dark); }
.section-title {
  color: #2c3e50; margin-top: 30px; margin-bottom: 10px; font-size: 20px; display: flex; align-items: center; gap: 10px;
}

/* HEADER & DASHBOARD */
.header-container { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
.dashboard { display: flex; gap: 15px; margin-top: 12px; }
.stat-box {
  background: #fff; padding: 10px 18px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); font-size: 14px; font-weight: bold; color: var(--text-dark); border-left: 5px solid #3498db;
}
.stat-box:nth-child(2) { border-left-color: #00c875; } 
.stat-box:nth-child(3) { border-left-color: #fdab3d; } 
.stat-box:nth-child(4) { border-left-color: #e2445c; } 

.controls { display: flex; gap: 10px; align-items: center; }
#searchInput { padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; width: 200px; outline: none; font-size: 14px; }
#searchInput:focus { border-color: #3498db; }

.main-btn {
  background: #3498db; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s;
}
.main-btn:hover { filter: brightness(1.1); }
.export-btn { background: var(--excel-green); }

/* SIDEBAR */
#excelSidebar {
  position: fixed; left: -260px; top: 0; width: 260px; height: 100vh; background: #2c3e50; color: #fff; display: none; flex-direction: column; transition: left 0.3s; z-index: 1000; box-shadow: 4px 0 15px rgba(0,0,0,0.2);
}
#excelSidebar.active, #excelSidebar:hover { left: 0; }
#sidebarTrigger {
  position: absolute; right: -30px; top: 50%; transform: translateY(-50%); width: 30px; height: 80px; background: #2c3e50; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 0 8px 8px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2);
}
.sidebar-section { padding: 15px 20px 5px; font-size: 12px; color: #bdc3c7; text-transform: uppercase; }
.sidebar-btn {
  margin: 5px 20px; padding: 10px 15px; border: none; background: #34495e; color: #fff; cursor: pointer; border-radius: 4px; font-weight: bold; text-align: left; transition: 0.2s;
}
.sidebar-btn:hover { background: #3498db; padding-left: 20px; }
.sidebar-btn.danger { background: #c0392b; }
.sidebar-btn.danger:hover { background: #e74c3c; padding-left: 15px; }
.sidebar-btn.save-btn { margin-top: auto; margin-bottom: 30px; background: #27ae60; text-align: center; font-size: 16px; padding: 15px;}
.sidebar-btn.save-btn:hover { background: #2ecc71; padding-left: 15px; }

/* TABLE & SCROLLER */
.table-wrapper {
  overflow-x: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-radius: 8px; background: #fff; max-height: 50vh; margin-bottom: 20px; padding-bottom: 5px;
}
.table-wrapper::-webkit-scrollbar { height: 12px; }
.table-wrapper::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 8px; margin: 0 10px; }
.table-wrapper::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 8px; border: 2px solid #f1f1f1;}
.table-wrapper::-webkit-scrollbar-thumb:hover { background: #95a5a6; }

table { width: 100%; border-collapse: collapse; background: #fff; min-width: 1400px; }
th, td { border: 1px solid var(--border-color); padding: 8px 10px; font-size: 13px; text-align: center; white-space: nowrap; }
th { position: sticky; color: #fff; font-size: 14px; box-shadow: 0 2px 2px -1px rgba(0,0,0,0.4); z-index: 3; }

/* DYNAMIC HEADER STYLES */
.sort-header th { height: 35px; top: 0; cursor: pointer; user-select: none; background: #34495e; }
.sort-header th:hover { filter: brightness(0.9); }
.filter-row th { top: 55px; background: #ecf0f1 !important; padding: 5px; border-top: none; z-index: 2;}
.col-filter { width: 100%; box-sizing: border-box; padding: 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
.col-filter:focus { border-color: #3498db; }

/* DEFAULT COLUMN COLORS (Overrides applied dynamically) */
.sort-header th:nth-child(1), .sort-header th:nth-child(3) { background: #2980b9; }
.sort-header th:nth-child(2) { background: #c0392b; }
.sort-header th:nth-child(4), .sort-header th:nth-child(5) { background: #8e44ad; }
.sort-header th:nth-child(6) { background: #d35400; }
.sort-header th:nth-child(7) { background: #7f8c8d; }
.sort-header th:nth-child(8) { background: #9b59b6; }
.sort-header th:nth-child(9), .sort-header th:nth-child(10) { background: #27ae60; }

td:nth-child(1) { background: #ebf5fb; }
td:nth-child(2) { background: #fadbd8; }
td:nth-child(3) { background: #d6eaf8; font-weight: 500;}
td:nth-child(4) { background: #e8daef; }
td:nth-child(5) { background: #d2b4de; }
td:nth-child(7) { background: #eaeded; }
td:nth-child(8) { background: #c39bd3; }

/* PROJECT & WEEKLY STATUS COLORS */
.status-working { background: #fdab3d !important; color: #fff !important; font-weight: bold; }
.status-done { background: #00c875 !important; color: #fff !important; font-weight: bold; }
.status-stuck { background: #e2445c !important; color: #fff !important; font-weight: bold; }
.status-yet { background: #c4c4c4 !important; color: #fff !important; font-weight: bold; }
.week-yes { background: #2ecc71 !important; color: #fff; font-weight: bold; }
.week-no { background: #e74c3c !important; color: #fff; font-weight: bold; }
.week-na { background: #f1c40f !important; font-weight: bold; }
.week-waiting { background: #aed6f1 !important; font-weight: bold; }
.row-orange td { background: #f39c12 !important; font-weight: bold; color: black; }

/* DYNAMIC ELEMENTS */
select.dynamic-dropdown {
  width: 100%; height: 100%; border: none; font-weight: inherit; color: inherit; font-family: inherit; font-size: inherit;
  background: transparent; outline: none; cursor: pointer; appearance: none; text-align: center; text-align-last: center;
}
select.dynamic-dropdown option { background: #fff; color: #000; font-weight: normal; }

td[contenteditable="true"] { cursor: text; }
td[contenteditable="true"]:focus { outline: 3px solid var(--excel-green); outline-offset: -2px; box-shadow: inset 0 0 8px rgba(0,0,0,0.1); }
tr.active-row td { filter: brightness(0.92); }
.date-cell { cursor: pointer; position: relative; }
.date-cell:hover::after { content: "üìÖ"; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); opacity: 0.5; }

/* RIGHT-CLICK CONTEXT MENU */
.context-menu {
  position: absolute; background: #fff; border: 1px solid var(--border-color); box-shadow: 2px 4px 12px rgba(0,0,0,0.2);
  z-index: 10000; border-radius: 6px; padding: 8px 0; min-width: 200px; list-style: none; margin: 0; display: none;
}
.context-menu li { padding: 8px 20px; font-size: 13px; cursor: pointer; color: #2c3e50; font-weight: 500; display: flex; align-items: center; gap: 10px;}
.context-menu li:hover { background: #f4f7f6; color: #3498db; }
.context-menu li.danger { color: #e74c3c; }
.context-menu li.danger:hover { background: #fdf5f5; }
.context-menu hr { border: none; border-top: 1px solid #ecf0f1; margin: 6px 0; }

/* MODAL STYLES */
.modal-overlay {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;
}
.modal-box {
  background: #fff; padding: 25px; border-radius: 8px; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.modal-box h3 { margin-top: 0; color: #2c3e50; }
.modal-box label { font-size: 13px; font-weight: bold; color: #7f8c8d; display: block; margin-top: 15px; margin-bottom: 5px;}
.modal-box select, .modal-box input {
  width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; box-sizing: border-box; font-family: inherit;
}
.modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
.modal-btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
.modal-btn.save { background: #27ae60; color: #fff; }
.modal-btn.cancel { background: #ecf0f1; color: #333; }

/* AUTOCOMPLETE */
.autocomplete-items {
  position: absolute; border: 1px solid #bdc3c7; border-radius: 4px; z-index: 9999; background-color: #fff; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #ecf0f1; font-size: 13px; color: #2c3e50; }
.autocomplete-item:hover { background-color: #f4f7f6; color: #3498db; }
.autocomplete-item strong { color: #2980b9; }

/* TOAST NOTIFICATION */
#toast {
  visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
}
#toast.show { visibility: visible; opacity: 1; bottom: 50px; }
</style>
</head>

<body>

<div id="toast">Notification text</div>

<div id="colSettingsModal" class="modal-overlay">
  <div class="modal-box">
    <h3>‚öôÔ∏è Column Settings</h3>
    <p id="modalColName" style="margin:0; font-size:13px; color:#3498db; font-weight:bold;"></p>
    
    <label>Column Data Type:</label>
    <select id="colTypeSelect" onchange="toggleDropdownOptions()">
      <option value="text">üìù Free Text (Default)</option>
      <option value="date">üìÖ Date Picker</option>
      <option value="dropdown">üîΩ Select Dropdown</option>
    </select>
    
    <div id="dropdownOptionsDiv" style="display:none;">
      <label>Dropdown Options (comma separated):</label>
      <input type="text" id="colDropdownOptions" placeholder="e.g. Yes, No, Waiting, NA">
      <small style="font-size:11px; color:#7f8c8d;">Separate choices with a comma.</small>
    </div>
    
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-btn save" onclick="saveColumnSettings()">Save Settings</button>
    </div>
  </div>
</div>

<ul id="contextMenu" class="context-menu">
  <li class="ctx-header" onclick="renameColumnContext()">‚úèÔ∏è Rename Column</li>
  <li class="ctx-header" onclick="openColumnSettingsContext()">‚öôÔ∏è Column Settings (Type)</li>
  <hr class="ctx-header">
  <li class="ctx-header" onclick="addColumnContext(0)">‚ûï Insert Column Left</li>
  <li class="ctx-header" onclick="addColumnContext(1)">‚ûï Insert Column Right</li>
  <li class="ctx-header danger" onclick="deleteColumnContext()">üóëÔ∏è Delete Column</li>
  
  <li class="ctx-cell" onclick="copyCell()">üìã Copy</li>
  <li class="ctx-cell" onclick="pasteCell()">üì• Paste</li>
  <li class="ctx-cell" onclick="clearCell()">üßπ Clear Content</li>
  <hr class="ctx-cell">
  
  <li class="ctx-row" onclick="addRowContext(0)">‚¨ÜÔ∏è Insert Row Above</li>
  <li class="ctx-row" onclick="addRowContext(1)">‚¨áÔ∏è Insert Row Below</li>
  <li class="ctx-row" onclick="duplicateRowContext()">üóÇÔ∏è Duplicate Row</li>
  <li class="ctx-row" onclick="moveRowContext(-1)">üîº Move Row Up</li>
  <li class="ctx-row" onclick="moveRowContext(1)">üîΩ Move Row Down</li>
  <li class="ctx-row danger" onclick="deleteRowContext()">üóëÔ∏è Delete Row</li>
  <hr class="ctx-row">
  
  <li class="ctx-cell" onclick="toggleFormat('b')"><b>B</b> Bold Text</li>
  <li class="ctx-cell" onclick="toggleFormat('i')"><i>I</i> Italic Text</li>
  <li class="ctx-cell" onclick="setAlignment('left')">‚¨ÖÔ∏è Align Left</li>
  <li class="ctx-cell" onclick="setAlignment('center')">‚ÜîÔ∏è Align Center</li>
  <li class="ctx-cell" onclick="triggerColorPicker()">üé® Change Cell Color</li>
  <li class="ctx-cell" onclick="clearFormat()">üö´ Clear Formatting</li>
</ul>
<input type="color" id="hiddenColorPicker" style="display:none;" onchange="applyCellColor(this.value)">

<div class="header-container">
  <div>
    <h1>Aurus Certification Tracker</h1>
    <div class="dashboard">
      <div class="stat-box">üìä Total: <span id="statTotal">0</span></div>
      <div class="stat-box">‚úÖ Done: <span id="statComp">0</span></div>
      <div class="stat-box">‚è≥ Working on it: <span id="statProg">0</span></div>
      <div class="stat-box">üõë Stuck: <span id="statStuck">0</span></div>
    </div>
  </div>
  <div class="controls">
    <button class="main-btn export-btn" onclick="exportCSV()">üì§ Export CSV</button>
    <input type="text" id="searchInput" placeholder="üîç Global Search..." oninput="renderBodies()">
    <button id="adminBtn" class="main-btn" onclick="toggleAdmin()">üîí Enable Admin Mode</button>
  </div>
</div>

<h2 class="section-title">‚è≥ In-Progress & Queued Projects</h2>
<div class="table-wrapper">
<table id="inProgressTable"><thead></thead><tbody id="tbody-inprogress"></tbody></table>
</div>

<h2 class="section-title">‚úÖ Completed Projects</h2>
<div class="table-wrapper">
<table id="completedTable"><thead></thead><tbody id="tbody-completed"></tbody></table>
</div>

<script>
// INITIAL DATA CONSTANTS
const teamMembersList = [
  "Nitesh Kharose", "Harshal Chaudhari", "Hemantkumar Nikole", "Nagamani Gatti", "Vaishnavi Mate", "Ashrin Shaik", 
  "Praneetha Chandragiri", "Rushikesh Kadam", "Dipak Pawar", "Rohit Sonawane", "Prathamesh Chitodikar", "Prakash Borude",
  "Nilesh Dhongade", "Kalyani Wabale", "Raghav Naulakha", "Vishal Gaikwad", "Arjav Jain", "Akash deshmukh", "Tushar Phatak", 
  "Vrushabh Mundhe", "Prabhat kashyap", "Gayatri Kelhe", "Amol Datal", "Edara Venkata Lakshmi Siva Swetha", 
  "Devi srilakshmi Gudimetla", "ManiTeja Chittabattina", "Vishnu Vardhan Lekkala", "Yuva Sai Reddy Vaka", "SivaPuram KartikaPriya", 
  "Sanket Bargal", "Shivam Sonawane", "Kunal Shinde", "Nithyananda Thalla", "Swagata Ranagar", "Atharva Sharma",
  "Kartik Machare", "Sushant Gavade", "Gaurav Shitole", "Deepti Soni", "Dhruv Naina", "Hitendra Patel", 
  "Lekhana Somayajula", "Sumith Venkat Nallabothula", "Kritika Singh", "Shivani Sakanure", "Anusha Kanthed", 
  "Shubham Gilbile", "Harshitha Bhavnasai", "Pratik Patil", "Dheeraj Shukla", "Parag Jain", "Ishita Sakhala", 
  "Kalyani Raut", "Akhila Ravi"
];

const initialHeaders = ["SR NO", "EP ID", "Certification Name", "Start Date", "End Date", "Project Status", "Developer Name", "Team Lead Name", "Last Week", "9‚Äì13 Feb"];

const initialMeta = {
    3: { type: 'date' },
    4: { type: 'date' },
    5: { type: 'dropdown', options: ['Working on it', 'Done', 'Stuck', 'Yet to Start'] },
    8: { type: 'dropdown', options: ['YES', 'NO', 'NA', 'Waiting'] },
    9: { type: 'dropdown', options: ['YES', 'NO', 'NA', 'Waiting'] }
};

const rawInitialData = [
["1","EP-0128","Chase ISO Wiseasy R1 PTS V6 [04157999]","21/09/25","17/02/26","Working on it","Sakshi Gudmewar","Vrushabh Munde","YES","YES"],
["2","EP-0132","Flexa Wallet Instore Customer Presented Code","15/11/25","20/02/26","Working on it","Naga Mani Gatti","Harshal Chaudhari","YES","YES"],
["3","EP-0134","Flexa Wallet Instore Merchant Presented Code","15/11/25","20/02/26","Working on it","Naga Mani Gatti","Harshal Chaudhari","YES","YES"],
["4","EP-0136","Flexa Wallet Ecommerce Merchant Presented Code","15/11/25","31/03/26","Working on it","Naga Mani Gatti","Harshal Chaudhari","YES","YES"],
["5","EP-0137","BVNK Stable Coins","02/02/26","30/04/26","Working on it","Vaishnavi Mate","Harshal Chaudhari","YES","YES"],
["6","EP-0156","Fiserv Petro Outdoor Cert ‚Äì Gilbarco M7","14/01/26","13/05/26","Working on it","Mani teja , Arjav","Vishal Gaikwad","","YES"],
["7","EP-0157","WorldPay Network Token and Detokenization","10/01/26","10/02/26","Working on it","Harshitha Bhavnasai","Pratik Patil","","YES"],
["8","EP-0160","GetNet Chile Lane 8000 PTS6","NA","NA","Working on it","","Sanket Bargal","","YES"],
["9","EP-0161","GetNet In-store Implementation ‚Äì Mexico","NA","NA","Yet to Start","Kritika Singh","Pratik Patil","","YES"],
["10","EP-0163","Chase Stratus DCC","17/10/25","12/02/26","Working on it","Kartik Machare","Gaurav Shitole","","YES"],
["11","EP-0164","Chase UTF Tandem 3DS","24/09/25","16/02/26","Working on it","Kartik Machare","Gaurav Shitole","","YES"],
["12","EP-0165","Chase Stratus Store and Forward","05/12/25","12/02/26","Done","Gaurav Shitole","Gaurav Shitole","","YES"],
["13","EP-0166","Chase UTF Tandem Store and Forward","15/12/25","09/02/26","Stuck","Swagata","Gaurav Shitole","","Waiting"],
["14","EP-0167","ForumPay Wallet Ecommerce MPC","21/01/26","27/03/26","Working on it","Vaishnavi Mate","Harshal Chaudhari","YES","YES"],
["15","EP-0187","Chase ISO Petro Fuelman & FleetCor","17/12/25","15/02/26","Working on it","Akash Deshmukh","Vishal Gaikwad","","YES"],
["16","EP-0189","TSYS Ingenico Lane 3600","18/11/25","09/03/26","Working on it","Dipak Pawar","Rushikesh Kadam","","YES"],
["17","EP-0191","Fiserv Canada RAU083 ‚Äì Lane 8000","01/08/25","NA","Yet to Start","","Gayatri Kelhe","","YES"],
["18","EP-0192","Citcon Ecommerce Certification","05/08/25","08/10/25","Done","Hemantkumar Nikole","Harshal Chaudhari","","YES"],
["19","EP-0194","Incomm Gift Pre/Post Auth","29/01/26","27/02/26","Working on it","Parag Jain","Dheeraj Shukla","","YES"],
["20","EP-0195","Chase UTF EMV EBT","19/01/26","27/02/26","Working on it","Deepti Soni","Gaurav Shitole","","NA"],
["21","EP-0196","Worldpay Petro Mastercard 2.0","NA","NA","Yet to Start","Anusha","Vishal Gaikwad","","YES"],
["22","EP-0197","FD Valulink Gift Regression","NA","NA","Yet to Start","Prathamesh Chitodikar","Rushikesh Kadam","","YES"],
["23","EP-0198","Worldpay CTLS Cashback","18/08/25","06/03/26","Working on it","Prabhat Kashyap","Vrushabh Mundhe","YES","YES"],
["24","EP-0199","Worldpay Aurus 021 ‚Äì M450","01/10/25","27/02/26","Working on it","Kunal Shinde","Sanket Bargal","YES","YES"],
["25","EP-0200","Fiserv Europe ‚Äì Lane 8000","30/07/25","27/02/26","Working on it","Akhila Ravi","Dheeraj Shukla","","YES"],
["26","EP-0202","Fiserv LATAM Argentina ‚Äì A920","01/10/25","27/03/26","Working on it","Kalyani Raut, Shivam","Dheeraj Shukla","",""],
["27","EP-0203","Moneris Canada ‚Äì Macless","01/12/25","20/02/26","Working on it","Akhila Ravi","Dheeraj Shukla","","YES"],
["28","EP-0204","Worldpay Aurus 025 iOS","02/02/26","29/05/26","Working on it","Kunal Shinde","Sanket Bargal","YES","YES"],
["29","EP-0205","Worldpay Aurus 020 Android","01/10/25","27/02/26","Working on it","Kunal Shinde","Sanket Bargal","YES","YES"],
["30","EP-0206","Forage (4-H) EBT Ecommerce","NA","NA","Yet to Start","Prathamesh Chitodikar","Rushikesh Kadam","","NO"],
["31","EP-0207","Elavon Canada Viaconex DCC","13/08/25","17/02/26","Working on it","Pravalika","Sushant G","","YES"],
["32","EP-0208","Elavon Canada Viaconex SolEng","09/10/25","30/04/26","Working on it","Pravalika","Sushant G","","YES"],
["33","EP-0193","Soda Health OTC Ecommerce","02/02/26","27/03/26","Working on it","Parag Jain","Hemant Nikole","YES",""],
["34","EP-0209","Citcon Ecommerce GPay & ApplePay","08/09/25","08/10/25","Done","Hemantkumar Nikole","Harshal Chaudhari","","YES"],
["35","EP-0211","Incomm OTC Ecommerce","15/01/26","27/02/26","Working on it","Parag Jain","Hemant Nikole","YES","YES"],
["36","","KPN Processor Integration","","","Yet to Start","Ishita","Hemant Nikole","","YES"]
];

// STATE MANAGEMENT
let HEADERS = localStorage.getItem("trackerHeaders_v8") ? JSON.parse(localStorage.getItem("trackerHeaders_v8")) : [...initialHeaders];
let DATA = localStorage.getItem("trackerData_v8") ? JSON.parse(localStorage.getItem("trackerData_v8")) : JSON.parse(JSON.stringify(rawInitialData));
let FORMATS = localStorage.getItem("trackerFormats_v8") ? JSON.parse(localStorage.getItem("trackerFormats_v8")) : {};
let COLUMN_META = localStorage.getItem("trackerColMeta_v8") ? JSON.parse(localStorage.getItem("trackerColMeta_v8")) : JSON.parse(JSON.stringify(initialMeta));

let admin = false, activeRow = null;
let sortCol = -1, sortAsc = true;
let contextTarget = null;
let clipboardData = null; // Internal copy/paste memory

// UTILS
function showToast(msg, type="success") {
  const toast = document.getElementById("toast"); toast.innerText = msg;
  toast.style.background = type === "success" ? "#27ae60" : "#e74c3c";
  toast.className = "show"; setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}
function parseDate(dmy) {
    if(!dmy || dmy === "NA") return "";
    let p = dmy.split('/'); if(p.length === 3) return `${p[2].length === 2 ? "20"+p[2] : p[2]}-${p[1].padStart(2, '0')}-${p[0].padStart(2, '0')}`;
    return "";
}
function formatDate(ymd) {
    if(!ymd) return ""; let p = ymd.split('-'); if(p.length === 3) return `${p[2]}/${p[1]}/${p[0].slice(-2)}`;
    return "";
}
function getTextColorForBg(hex) {
    if(!hex) return "#000";
    let color = hex.charAt(0) === '#' ? hex.substring(1, 7) : hex;
    let r = parseInt(color.substring(0, 2), 16), g = parseInt(color.substring(2, 4), 16), b = parseInt(color.substring(4, 6), 16);
    return (((r * 299) + (g * 587) + (b * 114)) / 1000) > 128 ? '#000000' : '#ffffff';
}

// RENDER ENGINE
function renderHeaders() {
  ['inProgressTable', 'completedTable'].forEach(tid => {
      const thead = document.querySelector(`#${tid} thead`);
      let sortHtml = `<tr class="sort-header">`;
      HEADERS.forEach((h, i) => {
          let arrow = (i === sortCol) ? (sortAsc ? " ‚ñ≤" : " ‚ñº") : "";
          sortHtml += `<th onclick="sortTable(${i})" oncontextmenu="return false;">${h}${arrow}</th>`;
      });
      sortHtml += `</tr><tr class="filter-row">`;
      HEADERS.forEach((h, i) => {
          let val = thead.querySelector(`.col-filter[data-col="${i}"]`)?.value || "";
          sortHtml += `<th><input type="text" class="col-filter" data-col="${i}" placeholder="Filter..." value="${val}" oninput="renderBodies()"></th>`;
      });
      sortHtml += `</tr>`;
      thead.innerHTML = sortHtml;
  });
}

function renderBodies() {
 const tbProg = document.getElementById("tbody-inprogress"); const tbComp = document.getElementById("tbody-completed");
 tbProg.innerHTML = ""; tbComp.innerHTML = "";
 
 const globalQ = document.getElementById("searchInput").value.toLowerCase();
 const inProgF = Array.from(document.querySelectorAll("#inProgressTable .col-filter")).map(i => i.value.toLowerCase());
 const compF = Array.from(document.querySelectorAll("#completedTable .col-filter")).map(i => i.value.toLowerCase());

 let total = 0, compCount = 0, progCount = 0, stuckCount = 0;

 // Find dynamic indices
 let statusIdx = -1; let epIdx = -1;
 HEADERS.forEach((h, i) => { if(h.toLowerCase().includes("status")) statusIdx = i; if(h.toLowerCase().includes("ep id")) epIdx = i; });

 DATA.forEach((r, originalIndex) => {
  const statusStr = (statusIdx >= 0 && r[statusIdx]) ? r[statusIdx].toUpperCase().trim() : "";
  const isDone = statusStr === "DONE" || statusStr === "[COMPLETED]";

  if(globalQ && !r.join(" ").toLowerCase().includes(globalQ)) return;
  const activeF = isDone ? compF : inProgF;
  let match = true;
  for(let i = 0; i < activeF.length; i++) { if (activeF[i] && r[i] && !r[i].toLowerCase().includes(activeF[i])) { match = false; break; } }
  if (!match) return;

  if(isDone) compCount++; else if (statusStr === "WORKING ON IT" || statusStr === "[IN-PROGRESS]") progCount++; else if (statusStr === "STUCK") stuckCount++;
  total++;

  const tr = document.createElement("tr"); tr.dataset.index = originalIndex;
  if(epIdx >= 0 && r[epIdx] === "EP-0160") tr.classList.add("row-orange");
  
  tr.innerHTML = r.map((c, i) => {
   let colMeta = COLUMN_META[i] || { type: 'text' };
   let cls = "";
   let cellVal = c ? c.trim() : "";
   
   // Hardcoded Visual Overrides if user hasn't explicitly set custom colors
   if (i === statusIdx) {
       let v = cellVal.toUpperCase();
       if (v === "WORKING ON IT" || v === "[IN-PROGRESS]") cls = "status-working";
       else if (v === "DONE" || v === "[COMPLETED]") cls = "status-done";
       else if (v === "STUCK") cls = "status-stuck";
       else if (v === "YET TO START") cls = "status-yet";
   } else if (cellVal.toUpperCase() === "YES") cls="week-yes"; 
     else if (cellVal.toUpperCase() === "NO") cls="week-no";
     else if (cellVal.toUpperCase() === "NA") cls="week-na"; 
     else if (cellVal.toUpperCase().includes("WAIT")) cls="week-waiting";

   // Apply custom FORMATS (Bold, Italic, Color, Align)
   let fmt = (FORMATS[originalIndex] && FORMATS[originalIndex][i]) ? FORMATS[originalIndex][i] : {};
   let styleStr = '';
   if(fmt.bg) styleStr += `background-color: ${fmt.bg} !important; color: ${getTextColorForBg(fmt.bg)} !important;`;
   if(fmt.b) styleStr += `font-weight: bold;`;
   if(fmt.i) styleStr += `font-style: italic;`;
   if(fmt.a) styleStr += `text-align: ${fmt.a};`;

   // Determine Cell Content based on Column Type
   let content = cellVal;
   let isEditable = false;

   if (admin) {
       if (colMeta.type === 'dropdown') {
           let opts = colMeta.options || [];
           let optHtml = `<option value=""></option>` + opts.map(o => `<option value="${o}" ${o.toLowerCase() === cellVal.toLowerCase() ? 'selected' : ''}>${o}</option>`).join('');
           content = `<select class="dynamic-dropdown" onchange="updateCell(this.value, ${originalIndex}, ${i})">${optHtml}</select>`;
       } else if (colMeta.type === 'date') {
           cls += " date-cell";
       } else {
           isEditable = true; // Text type
       }
   }

   return `<td contenteditable="${isEditable}" class="${cls}" style="${styleStr}">${content}</td>`;
  }).join("");
  
  if (isDone) tbComp.appendChild(tr); else tbProg.appendChild(tr);
 });

 document.getElementById("statTotal").innerText = total; document.getElementById("statComp").innerText = compCount;
 document.getElementById("statProg").innerText = progCount; document.getElementById("statStuck").innerText = stuckCount;
}

// DATA UPDATER (For Dropdowns and text)
function updateCell(val, rIdx, cIdx) {
    DATA[rIdx][cIdx] = val; renderBodies();
}

document.addEventListener("input", e => {
 if(admin && e.target.tagName === "TD" && !e.target.querySelector('select')) {
  const tr = e.target.parentElement; const rIdx = parseInt(tr.dataset.index); const cIdx = [...tr.children].indexOf(e.target);
  DATA[rIdx][cIdx] = e.target.innerText;
  handleAutocomplete(e.target, cIdx);
  
  // Quick re-evaluate colors for known words if no custom format
  if(!FORMATS[rIdx] || !FORMATS[rIdx][cIdx]) {
      let v = e.target.innerText.toUpperCase().trim();
      e.target.classList.remove('week-yes','week-no','week-na','week-waiting');
      if(v === "YES") e.target.classList.add("week-yes");
      else if(v === "NO") e.target.classList.add("week-no");
      else if(v === "NA") e.target.classList.add("week-na");
      else if(v.includes("WAIT")) e.target.classList.add("week-waiting");
  }
 }
});

// SORTING LOGIC (Safely Moves FORMATS alongside DATA)
function sortTable(colIndex) {
  if (sortCol === colIndex) sortAsc = !sortAsc; else { sortCol = colIndex; sortAsc = true; }
  
  // Map data to include original formatting object
  let mapped = DATA.map((r, i) => ({ row: r, fmt: FORMATS[i] || {} }));
  
  mapped.sort((a, b) => {
    let valA = (a.row[colIndex]||"").toLowerCase(); let valB = (b.row[colIndex]||"").toLowerCase();
    if(colIndex === 0) { valA = parseInt(valA) || 0; valB = parseInt(valB) || 0; }
    if (valA < valB) return sortAsc ? -1 : 1;
    if (valA > valB) return sortAsc ? 1 : -1;
    return 0;
  });

  // Re-split into DATA and FORMATS
  DATA = mapped.map(m => m.row);
  FORMATS = {};
  mapped.forEach((m, i) => { if(Object.keys(m.fmt).length > 0) FORMATS[i] = m.fmt; });

  renderBodies(); renderHeaders();
}

function toggleAdmin() {
 if(!admin){
  if(prompt("Enter Admin Password:") !== "admin123") return showToast("Incorrect Password!", "error");
  admin = true; document.getElementById("adminBtn").innerText = "üîì Exit Admin Mode"; showToast("Admin Mode Enabled");
 } else {
  admin = false; document.getElementById("adminBtn").innerText = "üîí Enable Admin Mode";
  if(activeRow) activeRow.classList.remove("active-row"); activeRow = null;
 }
 renderBodies(); renderHeaders();
}

// ----- CONTEXT MENU ENGINE -----
document.addEventListener('contextmenu', function(e) {
    if(!admin) return;
    let th = e.target.closest('.sort-header th'); let td = e.target.closest('td');
    
    if (th || td) {
        e.preventDefault(); contextTarget = th || td;
        const menu = document.getElementById("contextMenu");
        menu.style.display = "block"; menu.style.left = e.pageX + "px"; menu.style.top = e.pageY + "px";

        const isHeader = !!th;
        document.querySelectorAll('.ctx-header').forEach(el => el.style.display = isHeader ? "flex" : "none");
        document.querySelectorAll('.ctx-row').forEach(el => el.style.display = isHeader ? "none" : "flex");
        document.querySelectorAll('.ctx-cell').forEach(el => el.style.display = isHeader ? "none" : "flex");
        
        if(td && activeRow) activeRow.classList.remove('active-row');
        if(td) { activeRow = td.parentElement; activeRow.classList.add('active-row'); }
    }
});
document.addEventListener('click', e => { 
    if(!e.target.closest('.context-menu')) document.getElementById("contextMenu").style.display = "none"; 
});

// HEADER ACTIONS
function renameColumnContext() {
    if(!contextTarget) return;
    const cIdx = contextTarget.cellIndex; const oldName = HEADERS[cIdx];
    const newName = prompt("Rename Column:", oldName);
    if(newName && newName !== oldName) { HEADERS[cIdx] = newName; renderHeaders(); renderBodies(); showToast("Column Renamed"); }
    document.getElementById("contextMenu").style.display = "none";
}
function addColumnContext(offset) {
    if(!contextTarget) return;
    const cIdx = contextTarget.cellIndex + offset;
    const colName = prompt("Enter new Column Name:");
    if(!colName) return;
    HEADERS.splice(cIdx, 0, colName); DATA.forEach(row => row.splice(cIdx, 0, ""));
    
    // Shift COLUMN_META and FORMATS keys
    let newMeta = {}; for(let k in COLUMN_META) { let key = parseInt(k); newMeta[key >= cIdx ? key+1 : key] = COLUMN_META[k]; } COLUMN_META = newMeta;
    for(let r in FORMATS) { let newFmt = {}; for(let k in FORMATS[r]){ let key = parseInt(k); newFmt[key >= cIdx ? key+1 : key] = FORMATS[r][k]; } FORMATS[r] = newFmt; }
    
    renderHeaders(); renderBodies(); showToast(`Column Added`);
    document.getElementById("contextMenu").style.display = "none";
}
function deleteColumnContext() {
    if(!contextTarget) return; const cIdx = contextTarget.cellIndex;
    if(confirm(`Delete column "${HEADERS[cIdx]}" forever?`)) {
        HEADERS.splice(cIdx, 1); DATA.forEach(row => row.splice(cIdx, 1));
        let newMeta = {}; for(let k in COLUMN_META) { let key=parseInt(k); if(key!==cIdx) newMeta[key > cIdx ? key-1 : key] = COLUMN_META[k]; } COLUMN_META = newMeta;
        for(let r in FORMATS) { let newFmt = {}; for(let k in FORMATS[r]){ let key=parseInt(k); if(key!==cIdx) newFmt[key > cIdx ? key-1 : key] = FORMATS[r][k]; } FORMATS[r] = newFmt; }
        renderHeaders(); renderBodies(); showToast(`Column Deleted`);
    }
    document.getElementById("contextMenu").style.display = "none";
}

// COLUMN SETTINGS MODAL
let editingColIdx = -1;
function openColumnSettingsContext() {
    if(!contextTarget) return;
    editingColIdx = contextTarget.cellIndex;
    document.getElementById("modalColName").innerText = "Column: " + HEADERS[editingColIdx];
    
    let meta = COLUMN_META[editingColIdx] || {type: 'text'};
    document.getElementById("colTypeSelect").value = meta.type;
    document.getElementById("colDropdownOptions").value = meta.options ? meta.options.join(', ') : "";
    
    toggleDropdownOptions();
    document.getElementById("colSettingsModal").style.display = "flex";
    document.getElementById("contextMenu").style.display = "none";
}
function toggleDropdownOptions() {
    const val = document.getElementById("colTypeSelect").value;
    document.getElementById("dropdownOptionsDiv").style.display = val === 'dropdown' ? 'block' : 'none';
}
function closeModal() { document.getElementById("colSettingsModal").style.display = "none"; }
function saveColumnSettings() {
    const type = document.getElementById("colTypeSelect").value;
    const optsRaw = document.getElementById("colDropdownOptions").value;
    
    COLUMN_META[editingColIdx] = { type: type };
    if(type === 'dropdown') {
        COLUMN_META[editingColIdx].options = optsRaw.split(',').map(s => s.trim()).filter(s => s.length > 0);
    }
    closeModal(); renderBodies(); showToast("Column Settings Saved");
}

// ROW ACTIONS
function addRowContext(offset) {
    if(!contextTarget) return;
    const rIdx = parseInt(contextTarget.parentElement.dataset.index) + offset;
    const r = Array(HEADERS.length).fill("");
    const statusIdx = HEADERS.indexOf("Project Status"); if(statusIdx >= 0) r[statusIdx] = "Yet to Start";
    DATA.splice(rIdx, 0, r);
    // Shift FORMATS
    let newFmts = {}; for(let k in FORMATS) { let key = parseInt(k); newFmts[key >= rIdx ? key+1 : key] = FORMATS[k]; } FORMATS = newFmts;
    renderBodies(); showToast("Row Added"); document.getElementById("contextMenu").style.display = "none";
}
function duplicateRowContext() {
    if(!activeRow) return; const rIdx = parseInt(activeRow.dataset.index);
    DATA.splice(rIdx + 1, 0, [...DATA[rIdx]]);
    let newFmts = {}; for(let k in FORMATS) { let key = parseInt(k); newFmts[key > rIdx ? key+1 : key] = FORMATS[k]; } 
    if(FORMATS[rIdx]) newFmts[rIdx+1] = {...FORMATS[rIdx]}; FORMATS = newFmts;
    renderBodies(); showToast("Row Duplicated"); document.getElementById("contextMenu").style.display = "none";
}
function deleteRowContext() {
    if(!activeRow) return; const rIdx = parseInt(activeRow.dataset.index);
    DATA.splice(rIdx, 1);
    let newFmts = {}; for(let k in FORMATS) { let key=parseInt(k); if(key!==rIdx) newFmts[key > rIdx ? key-1 : key] = FORMATS[k]; } FORMATS = newFmts;
    activeRow = null; renderBodies(); showToast("Row Deleted", "error"); document.getElementById("contextMenu").style.display = "none";
}
function moveRowContext(direction) {
    if(!activeRow) return; const rIdx = parseInt(activeRow.dataset.index); const targetIdx = rIdx + direction;
    if (targetIdx >= 0 && targetIdx < DATA.length) {
        [DATA[rIdx], DATA[targetIdx]] = [DATA[targetIdx], DATA[rIdx]];
        let temp = FORMATS[rIdx]; FORMATS[rIdx] = FORMATS[targetIdx]; FORMATS[targetIdx] = temp;
        if(!FORMATS[rIdx]) delete FORMATS[rIdx]; if(!FORMATS[targetIdx]) delete FORMATS[targetIdx];
        renderBodies(); 
        document.querySelectorAll("tbody tr").forEach(tr => { if(parseInt(tr.dataset.index) === targetIdx) { activeRow = tr; activeRow.classList.add("active-row"); }});
    }
    document.getElementById("contextMenu").style.display = "none";
}

// CELL ACTIONS (Format & Copy/Paste)
function getFormatObj() {
    if(!contextTarget) return null;
    const rIdx = parseInt(contextTarget.parentElement.dataset.index); const cIdx = contextTarget.cellIndex;
    if(!FORMATS[rIdx]) FORMATS[rIdx] = {}; if(!FORMATS[rIdx][cIdx]) FORMATS[rIdx][cIdx] = {};
    return FORMATS[rIdx][cIdx];
}
function toggleFormat(prop) {
    let f = getFormatObj(); if(!f) return; f[prop] = !f[prop]; renderBodies(); document.getElementById("contextMenu").style.display = "none";
}
function setAlignment(val) {
    let f = getFormatObj(); if(!f) return; f.a = val; renderBodies(); document.getElementById("contextMenu").style.display = "none";
}
function triggerColorPicker() { document.getElementById("hiddenColorPicker").click(); document.getElementById("contextMenu").style.display = "none"; }
function applyCellColor(hexColor) { let f = getFormatObj(); if(!f) return; f.bg = hexColor; renderBodies(); showToast("Color Applied"); }
function clearFormat() {
    if(!contextTarget) return; const rIdx = parseInt(contextTarget.parentElement.dataset.index); const cIdx = contextTarget.cellIndex;
    if(FORMATS[rIdx] && FORMATS[rIdx][cIdx]) { delete FORMATS[rIdx][cIdx]; renderBodies(); }
    document.getElementById("contextMenu").style.display = "none";
}

function copyCell() {
    if(!contextTarget) return;
    const rIdx = contextTarget.parentElement.dataset.index; const cIdx = contextTarget.cellIndex;
    clipboardData = DATA[rIdx][cIdx]; showToast("Copied to Clipboard"); document.getElementById("contextMenu").style.display = "none";
}
function pasteCell() {
    if(!contextTarget || clipboardData === null) return;
    const rIdx = contextTarget.parentElement.dataset.index; const cIdx = contextTarget.cellIndex;
    DATA[rIdx][cIdx] = clipboardData; renderBodies(); showToast("Pasted"); document.getElementById("contextMenu").style.display = "none";
}
function clearCell() {
    if(!contextTarget) return;
    const rIdx = contextTarget.parentElement.dataset.index; const cIdx = contextTarget.cellIndex;
    DATA[rIdx][cIdx] = ""; renderBodies(); document.getElementById("contextMenu").style.display = "none";
}

// ----- DATE PICKER -----
document.addEventListener("click", e => {
    if (admin && e.target.classList.contains("date-cell") && e.target.tagName === "TD" && !e.target.querySelector('input')) {
        const tr = e.target.parentElement; const colIndex = [...tr.children].indexOf(e.target);
        const currentVal = e.target.innerText.trim();
        e.target.innerHTML = ""; const input = document.createElement("input");
        input.type = "date"; input.value = parseDate(currentVal);
        input.style.width = "100%"; input.style.border = "none"; input.style.background = "transparent"; input.style.outline = "none";
        e.target.appendChild(input); input.focus(); try { input.showPicker(); } catch(err){}
        input.addEventListener("blur", () => {
            let newVal = input.value ? formatDate(input.value) : (currentVal === "NA" ? "NA" : "");
            e.target.innerHTML = newVal; DATA[parseInt(tr.dataset.index)][colIndex] = newVal;
        });
        input.addEventListener("change", () => input.blur());
    }
});

// ----- AUTOCOMPLETE -----
function closeAutocomplete() { let el = document.getElementById("autocomplete-list"); if(el) el.remove(); }
document.addEventListener("click", e => { if (e.target.className !== "autocomplete-item" && e.target.tagName !== "TD") closeAutocomplete(); });

function handleAutocomplete(cell, colIndex) {
  closeAutocomplete();
  const colName = HEADERS[colIndex] || "";
  if (!colName.toLowerCase().includes("name")) return; // Only apply to Name columns dynamically

  const parts = cell.innerText.split(','); const currentSearch = parts[parts.length - 1].trim().toLowerCase();
  if (!currentSearch) return;

  let matches = 0, listHTML = "";
  teamMembersList.forEach(name => {
    if (name.toLowerCase().includes(currentSearch)) {
      matches++; listHTML += `<div class="autocomplete-item" data-name="${name}">${name.replace(new RegExp(`(${currentSearch})`, "gi"), "<strong>$1</strong>")}</div>`;
    }
  });

  if (matches > 0) {
    const listContainer = document.createElement("div"); listContainer.setAttribute("id", "autocomplete-list"); listContainer.setAttribute("class", "autocomplete-items");
    const rect = cell.getBoundingClientRect(); listContainer.style.top = (rect.bottom + window.scrollY) + "px"; listContainer.style.left = (rect.left + window.scrollX) + "px"; listContainer.style.width = rect.width + "px";
    listContainer.innerHTML = listHTML; document.body.appendChild(listContainer);

    Array.from(listContainer.getElementsByClassName("autocomplete-item")).forEach(item => {
      item.addEventListener("click", function() {
        parts[parts.length - 1] = (parts.length > 1 ? " " : "") + this.getAttribute("data-name");
        cell.innerText = parts.join(',');
        DATA[parseInt(cell.parentElement.dataset.index)][colIndex] = cell.innerText;
        closeAutocomplete();
        const range = document.createRange(); const sel = window.getSelection(); range.selectNodeContents(cell); range.collapse(false); sel.removeAllRanges(); sel.addRange(range);
      });
    });
  }
}

// ----- GLOBALS & SAVING -----
function resetData() {
 if(confirm("‚ö†Ô∏è WARNING: This will delete all your edits and restore the original data. Are you sure?")) {
  HEADERS = [...initialHeaders]; DATA = JSON.parse(JSON.stringify(rawInitialData)); FORMATS = {}; COLUMN_META = JSON.parse(JSON.stringify(initialMeta));
  saveData(); renderHeaders(); renderBodies(); showToast("Reset to Default");
 }
}
function saveData() {
 localStorage.setItem("trackerHeaders_v8", JSON.stringify(HEADERS));
 localStorage.setItem("trackerData_v8", JSON.stringify(DATA));
 localStorage.setItem("trackerFormats_v8", JSON.stringify(FORMATS));
 localStorage.setItem("trackerColMeta_v8", JSON.stringify(COLUMN_META));
 showToast("üíæ Sheet Saved Successfully!"); renderBodies(); 
}
function exportCSV() {
 let csv = "";
 const thNodes = [...document.querySelectorAll("#inProgressTable .sort-header th")].map(th => `"${th.innerText.replace(/ ‚ñ≤| ‚ñº/g, "")}"`);
 csv += thNodes.join(",") + "\n";
 document.querySelectorAll("tbody tr").forEach(r => {
  csv += [...r.children].map((c) => {
      let val = c.innerText; if(c.querySelector('select')) val = c.querySelector('select').value;
      return `"${val.replace(/"/g, '""')}"`;
  }).join(",") + "\n";
 });
 const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type: "text/csv"}));
 a.download = "Aurus_Certification_Tracker.csv"; a.click(); showToast("Download Started");
}

renderHeaders(); renderBodies();
</script>
</body>
</html>
